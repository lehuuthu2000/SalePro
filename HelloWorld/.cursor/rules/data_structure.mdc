---
description: Thiết kế cơ sở dữ liệu MySQL cho phần mềm CRM cửa hàng.
globs: ["**/*.sql", "**/*.cs"]
alwaysApply: true
---

# Thiết kế Cơ sở dữ liệu (MySQL)

Dự án sử dụng MySQL (XAMPP). Dưới đây là lược đồ các bảng và quan hệ.

## 1. Bảng Users (Người dùng hệ thống)
Lưu thông tin nhân viên và quản trị viên đăng nhập hệ thống.

```sql
CREATE TABLE Users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL, -- Mật khẩu đã mã hóa
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE, -- Email người dùng (có thể NULL)
    is_admin BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 2. Bảng Customers (Khách hàng)
Lưu thông tin khách hàng thân thiết.

```sql
CREATE TABLE Customers (
    customer_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    phone_number VARCHAR(20) UNIQUE, -- Số điện thoại là định danh chính để tra cứu
    email VARCHAR(100),
    address VARCHAR(255),
    image BLOB, -- dữ liệu lưu ảnh nhị phân
    points INT DEFAULT 0, -- Điểm tích lũy (Optional)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 3. Bảng Categories (Danh mục sản phẩm)
Phân loại sản phẩm.

```sql
CREATE TABLE Categories (
    category_id INT AUTO_INCREMENT PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 4. Bảng Products (Sản phẩm - Thông tin chung)
Chứa thông tin chung của sản phẩm (không phải hàng hóa cụ thể bán ra).

```sql
CREATE TABLE Products (
    product_id INT AUTO_INCREMENT PRIMARY KEY,
    product_code VARCHAR(50) UNIQUE NOT NULL, -- Mã sản phẩm chung (VD: QUANJ01)
    product_name VARCHAR(200) NOT NULL,
    category_id INT,
    description TEXT,
    base_image_path VARCHAR(255), -- Hình ảnh đại diện
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES Categories(category_id) ON DELETE SET NULL,
    INDEX idx_product_name (product_name), -- Tối ưu tìm kiếm theo tên
    INDEX idx_product_code (product_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 5. Bảng ProductVariants (Chi tiết biến thể sản phẩm)
Đây là hàng hóa thực tế được bán (VD: Áo size M, Màu Đỏ).

```sql
CREATE TABLE ProductVariants (
    variant_id INT AUTO_INCREMENT PRIMARY KEY,
    product_id INT NOT NULL,
    sku VARCHAR(50) UNIQUE NOT NULL, -- Mã vạch chi tiết (VD: QUANJ01-M-DO)
    size VARCHAR(20), -- Kích thước (S, M, L, XL, 39, 40...)
    color VARCHAR(30), -- Màu sắc (Xanh, Đỏ...)
    import_price DECIMAL(15, 2) DEFAULT 0,
    selling_price DECIMAL(15, 2) DEFAULT 0,
    stock_quantity INT DEFAULT 0,
    total_sales_quantity INT DEFAULT 0, -- Tổng số lượng đã bán
    total_sales_amount DECIMAL(15, 2) DEFAULT 0, -- Tổng số tiền đã bán được
    image_path VARCHAR(255), -- Ảnh riêng cho biến thể (nếu có)
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE CASCADE,
    INDEX idx_variant_sku (sku) -- Tối ưu quét mã vạch
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 6. Bảng Orders (Hóa đơn bán hàng)
Lưu thông tin chung của đơn hàng.

```sql
CREATE TABLE Orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    order_code VARCHAR(20) UNIQUE NOT NULL, -- Mã hóa đơn (VD: HD20231010001)
    customer_id INT, -- Có thể NULL nếu khách vãng lai
    user_id INT NOT NULL, -- Nhân viên bán hàng
    tax DECIMAL(15,2) DEFAULT 0,
    total_amount DECIMAL(15, 2) NOT NULL, -- Tổng tiền sau chiết khấu
    discount_amount DECIMAL(15, 2) DEFAULT 0, -- Tiền giảm giá
    payment_method ENUM('Cash', 'Transfer', 'Card') DEFAULT 'Cash',
    status ENUM('Pending', 'Completed', 'Cancelled') DEFAULT 'Completed',
    shipping_address TEXT,
    billing_address TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    note TEXT,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id),
    FOREIGN KEY (user_id) REFERENCES Users(user_id),
    INDEX idx_order_created (created_at), -- Tối ưu báo cáo doanh thu theo ngày
    INDEX idx_order_code (order_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 7. Bảng OrderDetails (Chi tiết hóa đơn)
Lưu danh sách sản phẩm (biến thể) trong từng đơn hàng.

```sql
CREATE TABLE OrderDetails (
    order_detail_id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    variant_id INT NOT NULL, -- Liên kết đến biến thể cụ thể
    quantity INT NOT NULL DEFAULT 1,
    unit_price DECIMAL(15, 2) NOT NULL, -- Giá bán thực tế
    subtotal DECIMAL(15, 2) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES Orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (variant_id) REFERENCES ProductVariants(variant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## Ghi chú quan hệ (ERD)
- **Users** 1 - n **Orders**
- **Customers** 1 - n **Orders**
- **Categories** 1 - n **Products**
- **Products** 1 - n **ProductVariants**: Một sản phẩm cha có nhiều biến thể (Size/Màu).
- **Orders** 1 - n **OrderDetails**
- **ProductVariants** 1 - n **OrderDetails**: Chi tiết đơn hàng trỏ tới biến thể cụ thể.
